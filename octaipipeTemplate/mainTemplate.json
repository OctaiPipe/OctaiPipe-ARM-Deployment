{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "customerName": {
        "type": "string"
        //"defaultValue": "CompanyA"
      },
      "managedIdentityName": {
        "type": "string"
        //"defaultValue": "/subscriptions/0376d230-c884-4b5d-80b2-6759120231fc/resourceGroups/arm-test-deploy5/providers/Microsoft.ManagedIdentity/userAssignedIdentities/ARM-deployer"
      },
      "managedIdentityResourceGroup": {
        "type": "string",
        "defaultValue": "[resourceGroup().Name]"
      },
    "userEmails": {
      "type": "string",
      "metadata": {
        "description": "Newline-separated list of user email addresses"
      }
    }
    },

    "resources": [
      {
        "type": "Microsoft.Resources/deploymentScripts",
        "apiVersion": "2020-10-01",
        "name": "runADSetupScript",
        "location": "[resourceGroup().location]",
        "kind": "AzureCLI",
      "identity": {
          "type": "UserAssigned",
          "userAssignedIdentities": {
            "[resourceId(parameters('managedIdentityResourceGroup'), 'Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName'))]": {}
          }
      },
        "properties": {
          "azCliVersion": "2.47.0",
          "primaryScriptUri": "https://raw.githubusercontent.com/The-Data-Analysis-Bureau/OctaiPipe-ARM-Deployment/main/octaipipeTemplate/artifacts/azure_setup.sh",
          // try with env variables?
          "environmentVariables": [
            {
              "name": "readersAppRoleIdGuid",
              "value": "[guid(parameters('customerName'))]"
            }
          ],
          "arguments": "[concat('-c ', parameters('customerName'), ' -s ', variables('subscriptionId'), ' -t ', variables('tenantId'), ' -u ', parameters('userEmails'))]", 
          "timeout": "PT30M",
          "cleanupPreference": "OnSuccess",
          "retentionInterval": "P1D"
        }
      },
      {
        "name": "linkedTemplate",
        "dependsOn": [
          "runADSetupScript"
        ],
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2022-09-01",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "https://raw.githubusercontent.com/The-Data-Analysis-Bureau/OctaiPipe-ARM-Deployment/main/octaipipeTemplate/artifacts/linkedTemplate.json"
          },
          "parameters": {
            "customerName": {
              "value": "[parameters('customerName')]"
            },
            "azureAdGroupName": {
              "value": "[reference('runADSetupScript').outputs.azureAdGroupName.value]"
            },
            "azureAdGroupId": {
              "value": "[reference('runADSetupScript').outputs.azureAdGroupId.value]"
            },
            "clientId": {
              "value": "[reference('runADSetupScript').outputs.clientId.value]"
            },
            "tenantId": {
              "value": "[variables('tenantId')]"
            },
            "objectId": {
              "value": "[reference('runADSetupScript').outputs.objectId.value]"
            },
            "servicePrincipalSecret": {
              "value": "[reference('runADSetupScript').outputs.servicePrincipalSecret.value]"
            },
            "sqlAdminLogin": {
              "value": "[variables('sqlAdminLogin')]"
            },
            "sqlAdminLoginPassword": {
              "value": "[variables('sqlAdminLoginPassword')]"
            }
          }
        }
      }
  ],
      "outputs": {
        "sqlAdminLoginUser": {
            "type": "string",
            "value": "[variables('sqlAdminLoginUser')]"
        },
        "sqlAdminLoginPassword": {
            "type": "string",
            "value": "[variables('sqlAdminLoginPassword')]"
        }
    },
      "variables":{
        "tenantId": "[replace(subscription().id, '/tenants/', '')]",
        "subscriptionId": "[replace(subscription().id, '/subscriptions/', '')]",
        "sqlAdminLoginUser": "octaiadmin",
        "sqlAdminLoginPassword": "[substring(uniqueString(resourceGroup().name), 0, 8)]",
      }
    }